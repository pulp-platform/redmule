# Copyright 2023 ETH Zurich and University of Bologna.
# Solderpad Hardware License, Version 0.51, see LICENSE for details.
# SPDX-License-Identifier: SHL-0.51
#
# Author: Maurus Item (itemm@student.ethz.ch)
#
# This script configures and runs the vulnerability analysis for the pulp cluster core\

# CHANGE-ME: Relative place of InjectaFault Library
# Also change this in extract_nets.tcl
set injectafault_directory ../InjectaFault

# Disable transcript
transcript quietly

set script_base_path "${injectafault_directory}/scripts/"

# Import Netlist procs
source vulnerability_analysis/extract_nets.tcl


# General
set ::verbosity 2
set ::initial_run_proc pulp_vulnerable_net_analysis_initial_run_proc

proc pulp_vulnerable_net_analysis_initial_run_proc {} {
  run -all
}

# Vulnerability Analysis (Might already be set by Makefile)
if {![info exists ::initial_seed  ]} { set ::initial_seed       42 }
if {![info exists ::max_num_tests ]} { set ::max_num_tests  100000 }
set ::internal_state [list]

# Termination Monitor Signals
set ::correct_termination_signal    "/redmule_tb/correct_termination"
set ::incorrect_termination_signal  "/redmule_tb/incorrect_termination"
set ::exception_termination_signal  "/redmule_tb/exception_termination"
set ::custom_termination_signal_list {"/redmule_tb/retry_termination" "/redmule_tb/unnecesary_retry_termination"}

# Logging Settings
set ::log_latent_errors 0
set ::save_wlf_id_list  {}

# Manual Mode Settings
set ::show_waves          0
set ::show_fault_in_waves 0

# == Configure the settings for the fault injection script

# General Settings
set ::verbosity $::verbosity
set ::log_injections 0
set ::seed $::initial_seed
set ::print_statistics 0

# Time settings
# Warning: RedMulE TB timescale is in ps!
set ::earliest_injection_time    400000
set ::latest_injection_time      500000
set ::fault_period                    0
set ::rand_initial_injection_phase    0
set ::max_num_fault_inject            1
set ::signal_fault_duration        1000
set ::register_fault_duration         0

# Injection Settings
set ::allow_multi_bit_upset              0
set ::check_core_output_modification     0
set ::check_core_next_state_modification 0
set ::reg_to_sig_ratio                   1
set ::use_bitwidth_as_weight             0

# Select where to inject faults
set inject_registers 0
set inject_combinatorial_logic 1
set ::assertion_disable_list [list]
set ::inject_register_netlist [list]

# Create the netlists
set ::inject_signals_netlist [get_redmule_nets]

source ${injectafault_directory}/scripts/vulnerability_analysis.tcl

quit
